<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quantum Clicker 3D</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background-color: #000;
            font-family: 'Segoe UI', sans-serif;
            color: #0ff;
            user-select: none;
        }

        #game-ui {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none; /* Let clicks pass through to 3D canvas */
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 20px;
            box-sizing: border-box;
        }

        /* Stats Header */
        .header {
            text-align: center;
            text-shadow: 0 0 10px #0ff;
        }

        h1 { margin: 0; font-weight: 300; letter-spacing: 5px; font-size: 2rem; }
        
        #score-display {
            font-size: 4rem;
            font-weight: bold;
            margin: 10px 0;
        }
        
        #cps-display {
            font-size: 1.2rem;
            color: #888;
        }

        /* Upgrade Shop (Bottom) */
        .shop {
            pointer-events: auto; /* Re-enable clicks for buttons */
            background: rgba(0, 20, 40, 0.8);
            border-top: 2px solid #0ff;
            padding: 20px;
            display: flex;
            gap: 20px;
            justify-content: center;
            backdrop-filter: blur(5px);
        }

        .upgrade-btn {
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid #0ff;
            color: #0ff;
            padding: 15px;
            width: 200px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
        }

        .upgrade-btn:hover { background: rgba(0, 255, 255, 0.1); transform: translateY(-5px); }
        .upgrade-btn:active { transform: scale(0.95); }
        .upgrade-btn.disabled { opacity: 0.5; cursor: not-allowed; border-color: #555; color: #555; }

        .btn-title { font-weight: bold; font-size: 1.1rem; display: block; margin-bottom: 5px; }
        .btn-cost { font-size: 0.9rem; color: #aaa; }
        .btn-count { 
            position: absolute; top: 5px; right: 5px; 
            background: #0ff; color: #000; 
            font-size: 0.8rem; padding: 2px 6px; border-radius: 4px; 
        }

        .btn-back {
            position: absolute;
            top: 20px; left: 20px;
            pointer-events: auto;
            color: #555;
            text-decoration: none;
            border: 1px solid #333;
            padding: 5px 10px;
            transition: 0.2s;
        }
        .btn-back:hover { color: #0ff; border-color: #0ff; }

        /* Floating Text Animation */
        .floating-text {
            position: absolute;
            color: white;
            font-weight: bold;
            font-size: 1.5rem;
            pointer-events: none;
            animation: floatUp 1s forwards;
            text-shadow: 0 0 5px white;
        }

        @keyframes floatUp {
            0% { opacity: 1; transform: translateY(0) scale(1); }
            100% { opacity: 0; transform: translateY(-50px) scale(1.5); }
        }
    </style>
</head>
<body>

    <div id="canvas-container"></div>

    <div id="game-ui">
        <a href="../index.html" class="btn-back">EXIT SIMULATION</a>

        <div class="header">
            <h1>QUANTUM CORE</h1>
            <div id="score-display">0</div>
            <div id="cps-display">0 Qubits / sec</div>
        </div>

        <div class="shop">
            <button class="upgrade-btn" id="btn-click" onclick="buyUpgrade('click')">
                <span class="btn-count" id="count-click">0</span>
                <span class="btn-title">Superposition</span>
                <div class="btn-cost" id="cost-click">Cost: 15</div>
                <div style="font-size:0.8rem; margin-top:5px;">+1 Click Power</div>
            </button>

            <button class="upgrade-btn" id="btn-auto" onclick="buyUpgrade('auto')">
                <span class="btn-count" id="count-auto">0</span>
                <span class="btn-title">Entangler</span>
                <div class="btn-cost" id="cost-auto">Cost: 100</div>
                <div style="font-size:0.8rem; margin-top:5px;">+5 / sec</div>
            </button>

            <button class="upgrade-btn" id="btn-farm" onclick="buyUpgrade('farm')">
                <span class="btn-count" id="count-farm">0</span>
                <span class="btn-title">Qubit Farm</span>
                <div class="btn-cost" id="cost-farm">Cost: 1000</div>
                <div style="font-size:0.8rem; margin-top:5px;">+50 / sec</div>
            </button>
        </div>
    </div>

    <script>
        // --- GAME LOGIC ---
        let qubits = 0;
        let clickPower = 1;
        let autoRate = 0;

        const upgrades = {
            click: { count: 0, baseCost: 15, costMultiplier: 1.5, power: 1 },
            auto:  { count: 0, baseCost: 100, costMultiplier: 1.4, power: 5 },
            farm:  { count: 0, baseCost: 1000, costMultiplier: 1.3, power: 50 }
        };

        const ui = {
            score: document.getElementById('score-display'),
            cps: document.getElementById('cps-display'),
            btnClick: document.getElementById('btn-click'),
            btnAuto: document.getElementById('btn-auto'),
            btnFarm: document.getElementById('btn-farm')
        };

        function updateUI() {
            // Scientific Notation for large numbers
            ui.score.innerText = formatNumber(Math.floor(qubits));
            ui.cps.innerText = formatNumber(autoRate) + " Qubits / sec";

            updateButton('click');
            updateButton('auto');
            updateButton('farm');
        }

        function updateButton(type) {
            const data = upgrades[type];
            const cost = Math.floor(data.baseCost * Math.pow(data.costMultiplier, data.count));
            const btn = document.getElementById(`btn-${type}`);
            
            document.getElementById(`cost-${type}`).innerText = `Cost: ${formatNumber(cost)}`;
            document.getElementById(`count-${type}`).innerText = data.count;

            if (qubits >= cost) {
                btn.classList.remove('disabled');
            } else {
                btn.classList.add('disabled');
            }
        }

        function formatNumber(num) {
            if (num < 1000) return num;
            if (num < 1000000) return (num/1000).toFixed(1) + "k";
            if (num < 1000000000) return (num/1000000).toFixed(2) + "M";
            return num.toExponential(2);
        }

        function buyUpgrade(type) {
            const data = upgrades[type];
            const cost = Math.floor(data.baseCost * Math.pow(data.costMultiplier, data.count));

            if (qubits >= cost) {
                qubits -= cost;
                data.count++;
                
                if (type === 'click') clickPower += data.power;
                if (type === 'auto') autoRate += data.power;
                if (type === 'farm') autoRate += data.power;

                updateUI();
                
                // Visual Flair: Pulse the Core based on upgrade type
                pulseCore(type === 'click' ? 1.2 : 1.5);
            }
        }

        // Auto-generation Loop
        setInterval(() => {
            if (autoRate > 0) {
                qubits += autoRate / 10; // Run 10 times a second
                updateUI();
            }
        }, 100);


        // --- THREE.JS 3D SCENE ---
        const scene = new THREE.Scene();
        // Fog for depth
        scene.fog = new THREE.FogExp2(0x000000, 0.02);

        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.z = 5;

        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.getElementById('canvas-container').appendChild(renderer.domElement);

        // 1. The Core (Icosahedron)
        const geometry = new THREE.IcosahedronGeometry(1.5, 1); // Radius 1.5, detail 1
        const material = new THREE.MeshBasicMaterial({ 
            color: 0x00ffff, 
            wireframe: true,
            transparent: true,
            opacity: 0.8
        });
        const core = new THREE.Mesh(geometry, material);
        scene.add(core);

        // 2. Inner Glow (Sphere)
        const innerGeo = new THREE.SphereGeometry(1.2, 32, 32);
        const innerMat = new THREE.MeshBasicMaterial({ color: 0x001133 });
        const coreInner = new THREE.Mesh(innerGeo, innerMat);
        scene.add(coreInner);

        // 3. Floating Particles System
        const particlesGeo = new THREE.BufferGeometry();
        const particlesCount = 500;
        const posArray = new Float32Array(particlesCount * 3);

        for(let i=0; i<particlesCount * 3; i++) {
            posArray[i] = (Math.random() - 0.5) * 20; // Spread across space
        }

        particlesGeo.setAttribute('position', new THREE.BufferAttribute(posArray, 3));
        const particlesMat = new THREE.PointsMaterial({
            size: 0.05,
            color: 0x00ffff,
            transparent: true,
            opacity: 0.5
        });
        const starField = new THREE.Points(particlesGeo, particlesMat);
        scene.add(starField);


        // Raycaster for clicking
        const raycaster = new THREE.Raycaster();
        const mouse = new THREE.Vector2();

        function onMouseClick(event) {
            // Normalize mouse position
            mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
            mouse.y = - (event.clientY / window.innerHeight) * 2 + 1;

            raycaster.setFromCamera(mouse, camera);

            // Check if we clicked the Core
            const intersects = raycaster.intersectObjects([core, coreInner]);

            if (intersects.length > 0) {
                // SUCCESSFUL CLICK
                qubits += clickPower;
                updateUI();

                // 1. Visual Pulse
                pulseCore(1.2);

                // 2. Spawn Click Particles
                spawnClickParticles(intersects[0].point);

                // 3. Floating Text
                showFloatingText(event.clientX, event.clientY, `+${formatNumber(clickPower)}`);
            }
        }

        window.addEventListener('mousedown', onMouseClick);

        // Animation Vars
        let pulseScale = 1;
        
        function pulseCore(scale) {
            pulseScale = scale;
        }

        // Temporary particles array
        const tempParticles = [];

        function spawnClickParticles(pos) {
            for(let i=0; i<8; i++) {
                const geo = new THREE.BoxGeometry(0.1, 0.1, 0.1);
                const mat = new THREE.MeshBasicMaterial({ color: 0xffffff });
                const mesh = new THREE.Mesh(geo, mat);
                
                mesh.position.copy(pos);
                
                // Random velocity
                mesh.userData = {
                    vel: new THREE.Vector3(
                        (Math.random() - 0.5) * 0.2,
                        (Math.random() - 0.5) * 0.2,
                        (Math.random() - 0.5) * 0.2
                    ),
                    life: 60 // frames
                };
                
                scene.add(mesh);
                tempParticles.push(mesh);
            }
        }

        function showFloatingText(x, y, text) {
            const el = document.createElement('div');
            el.classList.add('floating-text');
            el.innerText = text;
            el.style.left = x + 'px';
            el.style.top = y + 'px';
            document.body.appendChild(el);
            setTimeout(() => el.remove(), 1000);
        }

        // --- ANIMATION LOOP ---
        function animate() {
            requestAnimationFrame(animate);

            // Rotate Core
            core.rotation.x += 0.005;
            core.rotation.y += 0.005;
            coreInner.rotation.x -= 0.005;

            // Pulse Effect logic (Lerp back to 1)
            pulseScale = THREE.MathUtils.lerp(pulseScale, 1 + (autoRate * 0.001), 0.1); 
            core.scale.set(pulseScale, pulseScale, pulseScale);
            coreInner.scale.set(pulseScale, pulseScale, pulseScale);

            // Rotate Stars
            starField.rotation.y += 0.001;

            // Animate Temp Particles (Explosions)
            for(let i=tempParticles.length-1; i>=0; i--) {
                const p = tempParticles[i];
                p.position.add(p.userData.vel);
                p.rotation.x += 0.1;
                p.userData.life--;
                
                if(p.userData.life <= 0) {
                    scene.remove(p);
                    tempParticles.splice(i, 1);
                }
            }

            renderer.render(scene, camera);
        }

        // Resize handler
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

        animate();
        updateUI(); // Init

    </script>
</body>
</html>